---
title: "Smoothing and regression splines"
author: "Biel Caballero Verg√©s, Svenja Menzenbach and Kleber Enrique Reyes Illescas"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading libraries, include=FALSE}
library(sm)
library(mgcv)
```

# Hirsutism dataset

## GAMs for hirsutism data
```{r}
hirs <- read.table("hirsutism.dat",header=T, sep="\t",fill=TRUE)

#summary(hirs)
attach(hirs)
```
```{r}
plot(hirs[,-c(1,3,4)])
```

```{r}
old.par<-par(mfrow=c(2,3))
for (j in c(2,6,7,8,9)) hist(hirs[,j],main=names(hirs)[j])
par(old.par)
```

```{r}
apply(hirs[,-c(1,3,4,5)],2,sd, na.rm = T) # sd: standard deviation
```

```{r}
apply(hirs[,-c(1,3,4,5)],2,function(x){diff(range(x, na.rm = T))})
```

Possible groups of variables:
- SysPres, weigth


```{r}
# multiple linear regression
gam_0.1 <- gam(FGm12 ~ FGm0 + SysPres + DiaPres + height + weight + Treatment)
summary(gam_0.1)
```
```{r}
plot(gam_0.1, all.terms=TRUE)
```

```{r}
# generative additive model
gam_1.1 <- gam(FGm12 ~ s(FGm0, by=Treatment) + s(SysPres, by=Treatment) + s(DiaPres, by=Treatment) + s(height, by=Treatment) + s(weight, by=Treatment))
summary(gam_1.1)
```

```{r}
plot(gam_1.1,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_1.1)[1])
```
```{r}
gam.check(gam_1.1)
```
This first model is not good, since the results of the significance test were negative and the plots from the gam.check are not as expected.

```{r} 
gam_1.2 <- gam(FGm12 ~ s(FGm0) + s(SysPres) + s(DiaPres) + s(height) + s(weight))
summary(gam_1.2)
```


```{r}
plot(gam_1.2,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_1.1)[1])
```
```{r}
gam.check(gam_1.2)
```


```{r}
# Generalized nonparametric multiple regression model
gam_2.1 <- gam(FGm12 ~ te(FGm0, weight)) # SysPres, DiaPres, height, Treatment)
summary(gam_2.1)
```
```{r}
plot(gam_2.1,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_2.1)[1])
```
```{r}
gam.check(gam_2.1)
```



```{r}
# semiparametric model - SysPres (low df at model 1.1)
gam_3.1 <- gam(FGm12 ~ s(FGm0, by=Treatment) + SysPres + s(DiaPres, by=Treatment) + s(height, by=Treatment) + s(weight, by=Treatment))
summary(gam_3.1)
```
```{r}
plot(gam_3.1,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_3.1)[1])
```
```{r}
gam.check(gam_3.1)
```
```{r}
# semiparametric model - FGm0 (low df at model 1.1)
gam_3.2 <- gam(FGm12 ~ FGm0 + s(SysPres, by=Treatment) + s(DiaPres, by=Treatment) + s(height, by=Treatment) + s(weight, by=Treatment))
summary(gam_3.2)
```
```{r}
plot(gam_3.2,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_3.1)[1])
```
```{r}
gam.check(gam_3.2)
```
```{r}
# semiparametric model - DiaPres (low df at model 1.1)
gam_3.3 <- gam(FGm12 ~ s(FGm0, by=Treatment) + s(SysPres, by=Treatment) + DiaPres + s(height, by=Treatment) + s(weight, by=Treatment))
summary(gam_3.3)
```
```{r}
plot(gam_3.3,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_3.3)[1])
```
```{r}
gam.check(gam_3.3)
```

```{r}
# semiparametric model - FGmO + SysPres
gam_4.1 <- gam(FGm12 ~ FGm0 + SysPres + s(DiaPres, by=Treatment) + s(height, by=Treatment) + s(weight, by=Treatment))
summary(gam_4.1)
```
```{r}
plot(gam_4.1,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_4.1)[1])
```
```{r}
gam.check(gam_4.1)
```

```{r}
# semiparametric model - FGmO + DiaPres
gam_4.2 <- gam(FGm12 ~ FGm0 + s(SysPres, by=Treatment) + DiaPres + s(height, by=Treatment) + s(weight, by=Treatment))
summary(gam_4.2)
```
```{r}
plot(gam_4.2,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_4.2)[1])
```
```{r}
gam.check(gam_4.2)
```

```{r}
gam_5.1 <- gam(FGm12 ~ FGm0 + SysPres + s(DiaPres, by=Treatment) + s(height, by=Treatment) + s(weight))
summary(gam_5.1)
```
```{r}
plot(gam_5.1,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_5.1)[1])
```
```{r}
gam.check(gam_5.1)
```

```{r}
gam_6.1 <- gam(FGm12 ~ SysPres +  s(FGm0,SysPres, by=Treatment, k=5) + s(height, k=25, bs="cr") + s(weight,fx=TRUE,bs="cr"))
summary(gam_6.1)
```
Since the interaction is taking into account the different factors from Treatment we had a lot of uncertainty
```{r}
plot(gam_6.1,residuals=TRUE, shade=TRUE, shade.col="lightblue", seWithMean=TRUE, cex=3, lwd=2, shift= coef(gam_6.1)[1])
```
```{r}
vis.gam(gam_6.1, view = c("FGm0","SysPres"), plot.type = "persp", se=2, 
            theta = 140,  phi=30)
```

```{r}
gam.check(gam_6.1)
```


```{r}
plot(gam_1.1, residuals = TRUE,
     shade=TRUE, cex=2, lwd=2, 
     shift = gam_1.1$coefficients[1],
     seWithMean=TRUE,
     main=paste("Equiv. no. params.=",
                round(sum(gam_1.1$edf),2)))
```
```{r}
vis.gam(gam_5.1,view=c("FGm0","Treatment"),
        theta = 40, phi = 40, r = sqrt(3), d = 1,)
vis.gam(gam_5.1, view=c("FGm0","Treatment"), plot.type = "persp", theta=40, phi=40)
vis.gam(gam_5.1, view=c("FGm0","weight"), plot.type = "contour")
```


## Anova tests

```{r}
anova(gam_0.1,gam_1.1,test="F")
```
Gam_1.1 better
```{r}
anova(gam_0.1,gam_1.2,test="F")
```
Gam_1.2 better
```{r}
anova(gam_1.2,gam_1.1,test="F")
```
Gam_1.1 better (with treatment)
```{r}
anova(gam_2.1,gam_1.1,test="F")
```

Gam_1.1 better
```{r}
anova(gam_3.1,gam_3.2,test="F")
```

Gam_3.2 better

```{r}
anova(gam_3.2,gam_3.3,test="F")
```
Gam_3.2 better

```{r}
anova(gam_3.2,gam_1.1,test="F")
```
Gam_1.1 better

```{r}
anova(gam_4.1,gam_4.2,test="F")
```
Gam_4.1 better

```{r}
anova(gam_4.1,gam_1.1,test="F")
```
Gam_4.1 better


```{r}
anova(gam_4.1,gam_5.1,test="F")
```

Gam_5.1 better

```{r}
anova(gam_5.1, gam_6.1,test="F")
```

Gam_6.1 better
```{r}
anova(gam_2.1, gam_3.2, gam_3.1, gam_5.1, gam_6.1, test="F")
```
Looking at the anova of all models that we fitted, we could conclude that the best model is the gam_3.1. We select this model as the best one because is the one with the lowest deviance. 













