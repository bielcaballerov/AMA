---
title: "Local Poisson regression"
author: "Biel Caballero Verg√©s, Svenja Menzenbach and Kleber Enrique Reyes Illescas"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Bandwidth choice for the local Poisson regression

```{r}
h.cv.sm.poisson <- function(x, y, rg.h = NULL, l.h = 10, method = loglik.CV) {
  cv.h <- numeric(l.h)
  
  if (is.null(rg.h)) {
    hh <- c(h.select(x, y, method = "cv"), h.select(x, y, method = "aicc"))
    rg.h <- range(hh) * c(1/1.1, 1.5)
  }
  
  gr.h <- exp(seq(log(rg.h[1]), log(rg.h[2]), length.out = l.h))
  
  for (i in 1:length(gr.h)) {
    cv.h[i] <- method(x, y, gr.h[i])
  }
  
  return(list(h = gr.h, cv.h = cv.h, h.cv = gr.h[which.min(cv.h)]))
}
```

```{r}
loglik.CV <- function(x, y, h) {
  n <- length(x)
  pred <- sapply(1:n, function(i, x, y, h) {
    lambda_i <- sm.poisson(x = x[-i], y = y[-i], h = h, eval.points = x[i], display = "none")$estimate$lambda
    dpois(y[i], lambda = lambda_i, log = TRUE)
  }, x, y, h)
  
  return(-sum(pred) / n)
}
```


# 2. Local Poisson regression for Country Development Data

```{r}
# Load required library
library(sm)

data <- read.csv("HDI.2017.subset.csv", sep = ";", header = TRUE)  # Replace with your file path

le_fm <- as.numeric(gsub(",", ".",data$le.fm))

life_expec <- as.numeric(gsub(",", ".",data$Life.expec))

le_fm_r <- round(le_fm)

cv_result <- h.cv.sm.poisson(life_expec, le_fm_r)

selected_bandwidth <- cv_result$h.cv

model <- sm.poisson(x = life_expec, y = le_fm_r, h = selected_bandwidth)

summary(model)

```
