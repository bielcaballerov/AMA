---
title: "Smoothing and regression splines"
author: "Biel Caballero Vergés, Svenja Menzenbach and Kleber Enrique Reyes Illescas"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loading libraries, include=FALSE}
library(sm)
```

### Load data
```{r loading data}
load("bikes.Washington.Rdata")
attach(bikes)
```

## 1. Consider the nonparametric regression of cnt as a function of instant. Estimate the regression function m(instant) of cnt as a function of instant using a cubic regression spline estimated with the R function smooth.splines and choosing the smoothing parameter by Generalized Cross Validation.
```{r}
sm.sp <- smooth.spline(x = instant, y = cnt, 
                         cv = FALSE, all.knots = FALSE)
sm.sp

# Number of knots
sm.sp$fit$nk-2
```

### a) Which is the value of the chosen penalty parameter $\lambda$?
The value of $\lambda$ is 1.005038e-07.

### b) Which is the corresponding equivalent number of degrees of freedom df?
The corresponding equivalent number of degrees of freedom (df) is 93.34091.

### c) How many knots have been used?
We have used 134 knots.

### d) Give a graphic with the scatter plot and the estimated regression function $\hat{m}$(instant).
```{r}
plot(instant, cnt, col=8)
lines(sm.sp, col=2, lwd=2)
```


## 2. The script IRWLS logistic regression.R includes the definition of the function logistic.IRWLS.splines performing nonparametric logistic regression using splines with a IRWLS procedure. The basic syntax is the following: logistic.IRWLS.splines(x=..., y=..., x.new=..., df=..., plts=TRUE) where the arguments are the explanatory variable x, the 0-1 response variable y, the vector x.new of new values of variable x where we want to predict the probability of y being 1 given that x is equal to x.new, the equivalent number of parameters (or model degrees of freedom) df, and the logical plts indicating if plots are desired or not. Define a new variable cnt.5000 taking the value 1 for days such that the number of total rental bikes is larger than or equal to 5000, on 0 otherwise.
```{r}
source("IRWLS_logistic_regression.R")
cnt.5000 <- as.numeric(cnt >= 5000)
```

### a) Use the function logistic.IRWLS.splines to fit the non-parametric binary regression cnt.5000 as a function of the temperature, using df=6. In which range of temperatures is Pr(cnt >= 5000|temp) larger than 0,5?
```{r}
IRWLS.sp <- logistic.IRWLS.splines(x=temp, y=cnt.5000, x.new=temp, df=6, plts=TRUE)
x.05 <- x[as.numeric(IRWLS.sp$predicted.values >= 0.5) == 1]
x.05
x.min <- min(x.05)
x.max <- max(x.05)
print(sprintf("min: %d,  max: %d", x.min, x.max))
```
Looking at the plot, the temperatures between 20° and 35° have Pr(cnt >= 5000|temp) larger than 0.5. Except for the first plot, here we cannot fully observe the range. When determining the temperature from the returned prediction the range of x is between 21° and 75°. 

### b) Choose the parameter df by k-fold log-likelihood cross validation with k = 5 and using df.v = 3:15 as the set of possible values for df.
```{r}
# it is not log likelihood yet !!!!! (I changed  function from A4)
k.fold.ll.cv <- function(x,y,k=5,df){
  n <- length(x)
  Ik <- floor((0:(n-1))/(n/k))+1
  ssr <- 0
  for (i in (1:k)){
    y.i <- y[Ik==i]
    aux <- IRWLS.sp <- logistic.IRWLS.splines(x[Ik!=i], y[Ik!=i],                                    x.new=x[Ik!=i], df=df,plts=FALSE)
    ssr <- ssr + sum((y.i-aux$predicted.values)^2)
  }
  k.cv <- ssr/n
  return(k.cv)
}
```


```{r}
df.v = 3:15

for (df in df.v){
  k.fold.ll.cv(temp, cnt.5000, df)
}
```






